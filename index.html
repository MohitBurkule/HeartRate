<html>
  <head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LCRH415DPW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LCRH415DPW');
</script>
<!---G tracking-->
<!-- 2016 Gordon Williams, gw@pur3.co.uk

Any copyright is dedicated to the Public Domain.
http://creativecommons.org/publicdomain/zero/1.0/

-->
    <meta charset="utf-8">
    <meta name="viewport" content="width=320, initial-scale=1">
    <title>Online Heart Rate Monitor</title>
  </head>
  <body>
    <p>Allow this website to use your webcam, then place your finger lightly over the camera and wait for the trace to stabilise.</p>
    <p>Put the tip of a finger carefully on the camera lens.Ensure that the camera image turns <b style="color:red;">red</b> </p>
    <p>You will have most success when there is light behind your finger. Hence we will attempt to turn on flashlight on your device . It can get hot please <b>do not burn</b> yourself!!This website works best on Chrome </p>
    <video id="v" width="100" height="100"  muted></video><!--style="display:none"  uncomment for hiding video -->
    <canvas id="c" width="100%" height="100" style="display:none"></canvas>
    <canvas id="g" width="100%" height="100"></canvas><br/>
    <div id="bpm">--</div>
    <div id="time_left"></div>
    <div id="avg_bright"></div>
    <form id="mainform" action="https://vedicheart.pythonanywhere.com/"  onsubmit="return submitData()" method="post">

      <input type="text" id="hdata" name="hdata" value="None" hidden ><br><br>
      <input type="submit" id="btnsubmit" value="Start">
	<br>Set Measurement timer for <br>  
	 1 <input type="radio" checked onclick="set_maxminutes(1);" name="timer" value="1">
	 3 <input type="radio" onclick="set_maxminutes(3);" name="timer" value="3">
	 5 <input type="radio" onclick="set_maxminutes(5);" name="timer" value="5">
    </form> 
    <p> Please maintain a calm posture and <b>do not move</b></p>
    
  <script>
    var started=false;
	var timer=null;
	var maxminutes=1
	var maxtimer=maxminutes*60000
	function set_maxminutes(x){
	maxminutes=x;
	maxtimer=maxminutes*60000
	}
    function submitData(){
	if(started && heartData["bright"].length>300)
		{
		stop_reading();
		document.getElementById("hdata").value=JSON.stringify(heartData);
		return true;
		}
	else {
		// Get the webcam's stream.// request user permission
		
		navigator.getUserMedia(constraints, startStream, function () {alert("camera permission is required for detecting heart rate "); });
		return false;
		}	
	}
var video, width,stopped, height, context, graphCanvas, graphContext, bpm,track,torchMaxRetry;
torchMaxRetry=5;
var hist = [];
stopped=false;
var heartData={bright:[],time:[]};    
navigator.getUserMedia = ( navigator.getUserMedia ||
                       navigator.webkitGetUserMedia ||
                       navigator.mozGetUserMedia ||
                       navigator.msGetUserMedia);
////https://stackoverflow.com/a/28991938
var constraints = {video: true, audio:false};
function reset(){
hist = [];
heartData={bright:[],time:[]}; 
localStorage.setItem("heartData", "");
timer_start();
}
function timer_start()
{
timer=Date.now();
}
function timer_stop()
{
document.getElementById("mainform").submit();
}

function stop_reading()
{
stopped=true;
video.pause();
bpm.innerHTML="Sending reading ... please stay on the page ";
}

function initialize() {
localStorage.setItem("heartData", "");
navigator.mediaDevices.enumerateDevices().then(function(devices) {
  devices.forEach(function(device) {
    console.log(device.kind + ": " + device.label +
                " id = " + device.deviceId/*, JSON.stringify(device,null,2)*/);
    if (device.kind=="videoinput" /*&& constraints.video===true*/)
      constraints.video = { optional: [{sourceId: device.deviceId}, { fillLightMode: "on" }] };
  });
  initialize2();
}).catch(function(err) {
  console.log(err.name + ": " + err.message);
});
}

  function initialize2() {
    // The source video.
    video = document.getElementById("v");
    width = video.width;
    height = video.height;

    // The target canvas.
    var canvas = document.getElementById("c");
    context = canvas.getContext("2d");

    // The canvas for the graph
    graphCanvas = document.getElementById("g");
    graphContext = graphCanvas.getContext("2d");
 
    // The bpm meter
    bpm = document.getElementById("bpm");
    
    
  }

  function startStream(stream) {
	started=true;
	document.getElementById("btnsubmit").value="Submit";
    video.srcObject = stream;
    track = stream.getVideoTracks()[0];
	video.play();
    
	setTimeout(function(){ 
            track.applyConstraints({
         advanced: [{torch: true}]
      })
        //alert('Turning on flashlight , if present ');
    }, 800); 
    timer_start();
    // Ready! Let's start drawing.
    requestAnimationFrame(draw);
  }

  function draw() {
    var frame = readFrame();
    if (frame) {
      getIntensity(frame.data);      
    }

    // Wait for the next frame.
    requestAnimationFrame(draw);
  }

  function readFrame() {
    try {
      context.drawImage(video, 0, 0, width, height);
    } catch (e) {
      // The video may not be ready, yet.
      return null;
    }
	if(torchMaxRetry!=0){
		track.applyConstraints({advanced: [{torch: true}]});
		torchMaxRetry=torchMaxRetry-1;
	}
    return context.getImageData(0, 0, width, height);
  }

  function getIntensity(data) {
    var len = data.length;
    var sum = 0;
	if(stopped)
		return 
    var sumr=0;
    var sumb=0;
    var sumg=0;
    var sum_real=0;
    for (var i = 0, j = 0; j < len; i++, j += 4) {
		sum += 0.5*data[j] + data[j+1] + data[j+2];//r g b a
	    	sum_real += data[j] + data[j+1] + data[j+2];//r g b a
		sumr+=data[j];
		sumg+=data[j+1];
		sumb+=data[j+2];
    }
    //console.log(sum / len); 
    document.getElementById("avg_bright").innerHTML="AVG BRIGHTNESS IS "+sum_real/len;	  
    hist.push({ bright : sum/len, time : Date.now() , r:sumr/len, b:sumb/len , g:sumg/len});
    heartData['bright'].push(sum/len);
    heartData['time'].push(Date.now());
	if(Date.now()-timer>maxtimer)
	{
		timer_stop();
		return 
	}
	document.getElementById("time_left").innerHTML="Time left "+((maxtimer-(Date.now()-timer))/60000).toFixed(2)+' Minutes'
	//console.log(Math.max(...heartData['bright']),Math.min(...heartData['bright']));
	try{
	if(len>10 && (Math.max(...heartData['bright'])-Math.min(...heartData['bright']))>20)
	{
	reset();
	console.log("reset");
	return ;
	}
	}
	catch (e){}
	
    // Check browser support
    if (typeof(Storage) !== "undefined") {
      // Store
      //localStorage.setItem("heartData", JSON.stringify(heartData));
      // Retrieve
      
    } else {
      document.alert("Sorry, your browser does not support Web Storage...Hence our site may not work");
    }
    while (hist.length>graphCanvas.width) hist.shift();
    // max and min
    var max = hist[0].bright;
    var min = hist[0].bright;
    hist.forEach(function(v) {
      if (v.bright>max) max=v.bright;
      if (v.bright<min) min=v.bright;
    });
    // thresholds for bpm
    var lo = min*0.6 + max*0.4;
    var hi = min*0.4 + max*0.6;
    var pulseAvr = 0, pulseCnt = 0;
    // draw
    var ctx = graphContext;
    ctx.clearRect(0, 0, graphCanvas.width, graphCanvas.height);
	ctx.strokeStyle = "#000000";
    ctx.beginPath();
    ctx.moveTo(0,0);
    hist.forEach(function(v,x) {
      var y = graphCanvas.height*(v.bright-min)/(max-min);
	  //console.log("bright is "+y);
      ctx.lineTo(x,y);
    });       
    ctx.stroke();
	
	//b
	var maxb = hist[0].b;
    var minb = hist[0].b;
    hist.forEach(function(v) {
      if (v.b>maxb) maxb=v.b;
      if (v.b<minb) minb=v.b;
    });
	ctx.beginPath();
	ctx.strokeStyle = "#0000FF";
    ctx.moveTo(0,0);
    hist.forEach(function(v,x) {
      var y = (v.b/v.bright)*graphCanvas.height*(v.bright-min)/(max-min);
	  //console.log("blue is "+y);
      ctx.lineTo(x,y);
    });       
    ctx.stroke();
	
	//g
	var maxg = hist[0].g;
    var ming = hist[0].g;
    hist.forEach(function(v) {
      if (v.g>maxb) maxg=v.g;
      if (v.g<minb) ming=v.g;
    });
	ctx.beginPath();
	ctx.strokeStyle = "#00FF00";
    ctx.moveTo(0,0);
    hist.forEach(function(v,x) {
      var y = (graphCanvas.height*(v.bright-min)/(max-min))*(v.g/v.bright);
	  //console.log("green is "+y);
      ctx.lineTo(x,y);
    });       
    ctx.stroke();
	
	//r
	var maxr = hist[0].r;
    var minr = hist[0].r;
    hist.forEach(function(v) {
      if (v.r>maxr) maxg=v.r;
      if (v.r<minr) ming=v.r;
    });
	ctx.beginPath();
	ctx.strokeStyle = "#FF0000";
    ctx.moveTo(0,0);
    hist.forEach(function(v,x) {
      var y = (v.r/v.bright)*graphCanvas.height*(v.bright-min)/(max-min);
	  //console.log("red is "+y);
      ctx.lineTo(x,y);
    });       
    ctx.stroke();
	
	
    // work out bpm
    var isHi = undefined;
    var lastHi = undefined;
    var lastLo = undefined;
    ctx.fillStyle = "red";
    hist.forEach(function(v, x) {
      if (isHi!=true && v.bright>hi) {
        isHi = true;
        lastLo = x;
      }
      if (isHi!=false && v.bright<lo) {
        if (lastHi !== undefined && lastLo !== undefined) {
          pulseAvr += hist[x].time-hist[lastHi].time;
          pulseCnt++;
          ctx.fillRect(lastLo,graphCanvas.height-4,lastHi-lastLo,4);
        }
        isHi = false;
        lastHi = x;
      }
    });
    // write bpm
    if (pulseCnt) {
      var pulseRate = 60000 / (pulseAvr / pulseCnt);
      bpm.innerHTML = pulseRate.toFixed(0)+" BPM ("+pulseCnt+" pulses)";
    } else {
      bpm.innerHTML = "-- BPM";
    }
  }

  addEventListener("DOMContentLoaded", initialize);
  </script>
    <h3>Disclaimer</h3>
    This is an app which tries to determine your heart rate as best as it can, but it's not medical equipment.<br> Do not base any medical decisions solely on the results of this app.<br>Please contact a doctor when you are in need of medical advice or in an emergency .<br>
  </body>
</html>
